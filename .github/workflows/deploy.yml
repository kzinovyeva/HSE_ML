name: Deploy to GitHub Pages  # ← Имя workflow

on:
  push:
    branches: [ main, master ]  # ← Запуск при пуше в main/master
  workflow_dispatch:            # ← Ручной запуск из интерфейса

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      # 1. Клонируем репозиторий
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Устанавливаем Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. Устанавливаем marimo
      - name: Install marimo
        run: pip install marimo

      # 4. Экспортируем notebook
      - name: Export notebook
        run: |
          mkdir -p output
          
          # Экспортируем напрямую в index.html
          marimo export html-wasm notebooks/HW2.py -o output/index.html --mode run
          
          # Проверяем
          if [ -f "output/index.html" ]; then
            echo "✓ index.html created"
            SIZE=$(wc -c < output/index.html)
            echo "File size: $((SIZE/1024)) KB"
          else
            # Если не сработало, экспортируем в папку
            echo "Trying alternative export method..."
            marimo export html-wasm notebooks/HW2.py -o output --mode run
            
            # Создаем index.html который редиректит на созданный файл
            HTML_FILE=$(basename $(find output -name "*.html" -type f | head -1))
            if [ -n "$HTML_FILE" ]; then
              cat > output/index.html << EOF
              <!DOCTYPE html>
              <html>
              <head>
                <meta http-equiv="refresh" content="0; url=$HTML_FILE">
              </head>
              <body>
                <p>Redirecting to <a href="$HTML_FILE">notebook</a></p>
              </body>
              </html>
              EOF
              echo "✓ Created redirect to $HTML_FILE"
            fi
          fi

      # 5. Загружаем артефакт
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: output/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    permissions:
      pages: write
      id-token: write

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
